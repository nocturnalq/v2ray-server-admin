version: '3.9'
services:
  v2ray-server:
    container_name: v2ray-service
    depends_on:
      - pihole
    restart: unless-stopped
    image: v2fly/v2fly-core:{{ v2ray_version }}
    environment:
      - v2ray.vmess.aead.forced=false
    ports:
      - "{{ inbounds.port}}:{{ inbounds.port}}"
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    volumes:
      - "./server-config.json:/etc/v2ray/config.json"
      - "./logs:/var/log/v2ray/"
    networks:
      v2ray-net:
        ipv4_address: 10.11.10.6
    command: run -c /etc/v2ray/config.json
    dns:
      - 10.11.10.5
  # wireguard:
  #   image: linuxserver/wireguard
  #   container_name: wg-service
  #   depends_on:
  #     - pihole
  #   cap_add:
  #     - NET_ADMIN
  #     - SYS_MODULE
  #   env_file:
  #     - ./wireguard.env
  #   volumes:
  #     - ./wg/config:/config
  #     - ./wg/modules:/lib/modules
  #     - ./wg/src:/usr/src
  #   ports:
  #     - 51820:51820/udp
  #   dns:
  #     - 10.11.10.5
  #   sysctls:
  #     - net.ipv4.conf.all.src_valid_mark=1
  #   restart: unless-stopped
  #   networks:
  #     v2ray-net:
  #       ipv4_address: 10.11.10.7
  pihole:
    container_name: ph-service
    image: pihole/pihole:latest
    expose:
      - 53
      - 67
      - 80
      - 443
    env_file:
      - ./pihole.env
    volumes:
      - ./ph/etc.pihole:/etc/pihole/
      - ./ph/etc.dnsmasq.d/:/etc/dnsmasq.d/
    restart: unless-stopped
    networks:
      v2ray-net:
        ipv4_address: 10.11.10.5

networks:
  v2ray-net:
    driver: bridge
    ipam:
     config:
       - subnet: 10.11.10.0/16
         gateway: 10.11.10.1